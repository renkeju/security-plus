====================================
课题E：备份和恢复证书和私钥
====================================

在之前，你已经在CA基础架构中位需要证书的实体进行了注册。但是，证书及其相关私钥可能会丢失或被破坏，因此你需要通过一些方法来恢复它们。在本章课题中，你将备份证书和密钥，以便在丢失或受到威胁时恢复它们。

私钥保护方式
--------------------

私钥对于CA层次结构的安全性至关重要，并且加以保护，以防止丢失、被盗或破坏。
为了保护私钥，需要：

* 将私钥备份到可移动媒体并安全地保存该媒体。
* 从不安全地媒体中删除私钥。
* 恢复私钥时需要使用密码。
* 永远不要共享密钥。
* 密码发布后，切勿通过网络或互联网传输密钥。
* 考虑使用密钥托管将私钥存储到受信任地第三方。

密钥托管
----------------

作为密钥备份的替代方案，密钥托管（Key escrow）可以被用来安全地存储私钥，同时允许一个或多个受信任地第三方预定义条件下访问密钥。这个第三方被称为密钥托管代理（key escrow agent）。例如，在某些情况下，政府机构可能会要求私钥被放置在代理机构中进行托管。商业CA还可以为不想备份和管理自己的私钥的组织提供基于合同的托管服务。

M of N 控制
---------------------

在密钥托管方案中，只有特定数量的代理或受托人有权恢复密钥。为了防止单个授权代理恢复密钥，通常使用M of N方案（M of N scheme）。M of N方案是一种数学控制，考虑了密钥恢复代理的总数（N）以及执行密钥恢复所需的代理数量（M）。如果尝试恢复密钥的代理数量不满足或超过M，那么密钥将不会被恢复。M和N的确切值在不同的实施方案中各不相同。

私钥恢复方式
---------------------

如果私钥丢失或损坏，你就必须从备份或托管中恢复密钥，然后才能恢复任何加密数据。

* 如果你使用密钥托管，这个密钥就会被分割给多个托管代理。代理可以使用这些部分来重建丢失的密钥或直接解密信息。
* 如果密钥已备份到可移动介质，就可以从备份位置进行恢复。

EFS恢复代理
-------------------

加密文件系统[Encrypting File System（EFS）]使用Microsoft Windows基于NTFS的公钥加密。Windows Server 2016会根据用户证书自动创建加密证书和公钥；或者，你可以使用Windows Server 2016的Active Directory证书服务（AD CS）发布证书和密钥。

加密中可能会遇到一个问题是如何在加密文件的用户账户不存在的情况下恢复加密文件。例如，如果用户离开组织后删除这位用户的账户，就可能会出现此问题。Windows server 2016使你能够定义一个EFS恢复代理（recovery agent）。恢复代理是指有着能恢复被其他用户加密的文件所需证书的个人。默认情况下，Windows Server 2016将域管理员定义为EFS恢复代理。

密钥存档和恢复
^^^^^^^^^^^^^^^^^^^^^^

你还可以使用AD CS在受保护的CA数据库中的归档私钥，从而使私钥得以恢复。密钥恢复不会恢复加密的数据或消息，但它确实能帮助用户或管理员恢复密钥并在这之后用它来恢复数据（或解密数据）。

私钥替换
---------------

如果私钥丢失，你可能会像在恢复任何加密数据后将密钥全部都替换掉：

1. 首先，恢复私钥。
2. 解密任何被加密的数据。
3. 销毁原始密钥。
4. 获取一个新的密钥对。
5. 最后，使用新的私钥重新加密数据。
