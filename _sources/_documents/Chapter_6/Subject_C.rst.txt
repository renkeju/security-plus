============================================
课题C：实施安全的网络协议和服务
============================================

构成网络的技术及其设计与一系列常用网络协议和服务紧密结合。随着你继续探索网络安全领域，需要了解这些网络协议和服务在网络中的使用方式。

开放系统互连模式
-----------------------

开放系统互连模型[Open Systems Interconnection(OSI) mode]是一种根据网络与网络中的其他要素进行通讯的方式来抽象说明网路的构建方式的方法，类似于传输控制协议/Internet协议（TCP/IP）模型。这些要素按特定的顺序分为七个独立的层。顺序决定了层间的交互层次结构——一个层面支持在其之上的层，同时它又由下面的层所支持。OSI模型的主要目的是促进不同类型的网络产品和服务之间的无缝和一致通信。

.. csv-table:: OSI模型
    :header: "编号", "层", "描述", "主要协议和使用工具"
    :widths: 1 3 10 20

    "1", "物理", "定义设备和物理传输介质之间的连接", "物理连接组件（如电缆和布线）以及基本网络设备（如集线器，中继器和适配器）的规格。"
    "2", "数据链路", "提供两个直接相连节点之间的链路，并检测和修复物理层中的错误。", "点到点协议（PPP）：在节点之间提供加密、认证和压缩的连接协议。"
    "3", "网络", "在包含多个具有唯一地址的节点的系统（网络）中，提供将数据从一个节点传输到另一个节点的协议。", "Internet协议（IP）：管理互联网上的数字主机地址。 Internet 控制消息协议（ICMP）：测试设备之间的通讯并在网络功能不可用时发送错误消息。 路由信息协议（RIP）：通过限制源和目的地之间的中间设备数量来防止路由中的环路。"
    "4", "传输", "控制网络中节点之间数据传输的可靠性，使更高层能从中受益。", "传输控制协议（TCP）：一种面向连接的有保证传输协议。这意味着它不仅可以发送数据，还可以等待确认（ACK）并在可能的情况下修复错误。 用户数据协议（UDP）：通过绕过错误检查来确保数据包（数据报）的一致传输，这可能会导致延迟并要求更高的处理能力。 流控制传输协议（SCTP）：将TCP和UDP的功能合并到一个协议中。"
    "5", "会话", "通过检查点控制计算机之间的连接，以便在连接终止时可以恢复。", "网络文件系统（NFS）：允许用户客户端访问本地存储一样地访问网络上地文件。 套接字安全（SOCKS）：通过代理服务器在网络上路由数据包，其中还包含了身份验证。"
    "6", "表示", "将数据转换为上面应用层中地程序可以理解的格式。", "独立计算架构（ICA）：指定客户端和应用程序服务器之间的数据传输。"
    "7", "应用", "通过识别资源和通讯要求，使客户端于软件进行交互。", "超文本传输协议（HTTP）：允许在万维网上交换信息。 文件传输协议（FTP）：通过TCP网络在用户工作站和远程主机之间实现文件传输。 域名系统（DNS）：将人类可以理解的域名转换为相应的IP地址。"

OSI模型和安全性
----------------------------

作为一名安全专家，了解OSI模型的各个层面可以让你更容易地识别威胁及其目标，以及这些威胁如何影响你的网络。此外，按照层次保护你地网络使维护网络整体安全地一种有用策略，因为这些层次被设计为互相集成整合。如果最基本的层（物理）发生故障，那么其余可能也会发生故障。同样，如果攻击侵入安全性较差的应用层，则受保护的底层将无法纠正上述情况。

Internet协议套件
----------------------------

Internet 协议套件（Internet protocol suite）也称为传输控制协议/Internet协议[Transmission Control Protocol/Internet Protocol(TCP/IP)]套件，这是Internet的本地协议套件，是互联网连接所必需的。TCP/IP以包含在套件中的两个初始协议命名。下表介绍了构成该套件的其他常用协议。

.. csv-table:: Internet 协议套件
    :header: "TCP/IP协议", "描述"
    :widths: 5 30

    "IP版本4（IPv4）", "这是一种Internet标准，使用分配给TCP/IP网络上计算机的一个32位数字。地址中的一些位元表示网段；其他位代表计算机或节点本身。为了便于阅读，32位IPv4地址通常用点分成四个八位元（例如， 10101100.00010000.11110000.00000001），并且每个八位元被转换为一个十进制数值（例如，172.16.240.1）。"
    "IP版本6（IPv6）", "这是一种Internet标准，通过应用128位地址空间来增加可用的IP地址池。IPv6还包括了新的提效功能，如简化的地址头，分层寻址，支持时间敏感的网络流量，以及用于单播寻址的新结构。 IPv6地址通常用冒号分成八组，每组由四个十六进制数字：2001:0db8:85a3:0000:0000:8a2e:0370:7334。虽然所有八组必须有四位数字，但前导0可以被省略，如写作：2001:db8:85a3:0:0:8a2e:370:7334，其中连续的零组可以用两个冒号替换，如写作：2001:db8:85a3::8a2e:370:7334。 IPv4与IPv6不兼容，目前还没有向IPv4那样广泛部署。"
    "动态主机配置协议(DHCP)", "这种协议用于网络地址分配。DHCP会自动将IP寻址信息分配给IP网络计算机。除了手动分配静态IP地址的系统外，大多数IP系统从中央DHCP服务器或被配置成提供DHCP功能的路由器中动态获取地址信息。因此，DHCP服务是大多数企业环境中IP实施的关键组成。"

.. note:: Google在https://www.google.com/intl/en/ipv6/statistics.html网站中持续收集有关IPv6采用情况的统计信息。

.. note:: IP套件中还包含了许多其他协议，其中的一些在课题后面部分会有详细介绍。

APIPA
-----------

自动专私有IP寻址（APIPA）是一种Microsoft Windows服务，能使DHCP客户端计算机在DHCP不可用时初始化TCP/IP。当DHCP服务器发生故障或计算机没有连接时，DHCP客户端可以通过APIP获得IP地址。APIPA从169.254.0.1到169.254.255.254的小范围内随机自动分配地址。

域名系统
----------------

域名系统（DNS）是互联网和私有IP网络上的主要域名解析服务。DNS是一种将计算机名称映射到其相关联IP地址的分层数据库系统。DNS服务器存储，维护和更新数据库，并响应DNS客户端名称解析请求，将人类可理解的主机名称转换为IP地址。互联网上的DNS服务器共同工作，为所有互联网主机提供全局名称解析。

DNS安全措施
^^^^^^^^^^^^^^^^^^^^^^^

在任何公司网络中，DNS通常都是首先受到攻击的目标。IT市场中有几个应用程序可以帮补保护DNS。保护DNS可以采取的一些措施有：

* 将DNS服务器放在DMZ中并位于防火墙范围内。
* 设置防火墙规则以阻止不必要的入站服务请求。
* 只开放必要端口。
* 实施域名系统安全扩展[Domain Name System Security Extensions（DNSSEC）]，这种机制能提供DNS数据的认证并维护DNS数据的完成性。
* 定期更新DNS。操作系统供应商发布安全补丁更新DNS。
* 备份DNS并将备份保存在不同的地理位置。

超文本传输协议
-------------------------

超文本传输协议[Hypertext Transfer Protocol(HTTP)]是使客户端能连接到网站并与之进行交互的TCP/IP协议。它负责在系统之间传输网页上的数据。HTTP定义了消息的格式和传输方式，以及Web服务器和客户端浏览器响应不同命令时采取的操作。

安全套接字层/传输层安全
--------------------------------------

安全套接字层[Secure Sockets Layer(SSL)]和传输层安全[Transport Layer Security(TLS)]是集合了数字证书认证和公钥数据加密的安全协议。这两种协议通过在TCP/IP连接上使用安全、加密和经认证的通道来保护敏感通信免受窃听和篡改。SSL/TLS是一个服务器驱动的过程；任何支持SSL或TLS的Web客户端（包括所有当前的Web浏览器）都以安全连接到启用SSL或TLS的服务器。

SSL/TLS通常使用它的服务器软件提供。但是，SSL/TLS加速器（SSL/TLS accelerator）可以卸载SSL/TLS中的资源密集型的加密计算，以减少服务器的开销。这使服务器能更有效地履行其主要职责。SSL/TLS加速器通常使被插入到需要使用加密服务地服务器中的一种硬件卡，因此可以在网络中任何想要进行SSL/TLS卸载的地方放置加速器。

SSL/TLS 解密器
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

通过SSL/TLS加密的基于Web、VPN和其他流量对安全控制（如入侵检测、数据丢失防御和一般监控系统）提出了挑战。大多数此类解决方案无法读取加密流量以查找恶意行为，这严重限制了其功效。SSL/TLS解密器解决了这个问题，它能解密流量，然后将明文流量转发给相关安全设备进行解析。

TLS vs. SSL
^^^^^^^^^^^^^^^^^^^^^^^

尽管SSL经常与其他协议一起使用，但SSL是TLS的前身。最新版本的TLS比SSL更安全。

HTTP安全
---------------------

超文本传输协议安全[Hypertext Transfer Protocol Secure(HTTPS)]是HTTP的安全版本，它通过在Web浏览器和服务器之间提供安全连接来支持Web通讯。HTTPS使用SSL/TLS来加密数据。现在几乎所有的Web浏览器和服务器软件都支持HTTPS。启用SSL或TLS的Web地址以协议标识符 https:// 开头。

.. note:: HTTPS 也被称为基于SSL/TLS的HTTP。

安全Shell
------------------

安全Shell(SSH)是一种用于安全远程访问和安全数据传输的协议，SSH由一个服务器和一个客户端组成。大多数SSH客户端还应用了终端模拟软件以便在远程服务器上打开安全的终端会话。为确保安全性，整个SSH会话（包括身份验证）均使用各种加密方法进行加密。SSH是使用文件传输协议（FTP）的首选协议，主要用于在Linux和Unix系统上访问shell账户。Microsoft Windows本身并不提供对SSH的支持，但可以使用第三方工具来实现。

Telnet
-----------

Telnet是一种较早的网络协议，它允许客户端启动对基于TCP/IP主机的远程命令访问，与SSH类似。客户端运行一个Telnet程序，该程序可以建立与远程服务器的连接，为客户端授权一个虚拟终端到服务器中。大多数现代操作系统都支持Telnet；然而，现在不鼓励使用Telnet，因为它引入了严重的安全漏洞。Telnet协议未经加密，因此可以轻易地分析数据包，攻击者也可以窃听输入。中间人攻击也相对容易，因为Telnet不需要客户端和主机之间地任何认证。这导致了网络专业人员放弃了Telnet。

简单网络管理协议
-----------------------

简单网络管理协议[Simple Network Management Protocol(SNMP)]是一种用于从网络设备中收集信息进行诊断和维护的服务。SNMP包括两个组成部分：管理系统和代理软件，后者安装在网络设备（如服务器、路由器和打印机）上。代理将信息发送到SNMP管理器，然后SNMP管理器就能将有关问题通知给管理员，运行纠正程序或脚本，存储信息以供日后查看，或向代理询问特定的网络设备。

最新版本的SNMP是SNMPv3，它对协议通讯进行加密以支持机密性、完整性和身份验证。

实时传输协议
--------------------------

实时传输协议[Real-Time Transport Protocol(RTP)]提供了基于TCP/IP网络的音频和视频流媒体。RTP经常用于VoIP、网络会议、内容传递等服务。RTP使用UDP以低水平的开销传输媒体本身，同时与RTP控制协议（RTCP）结合使用，提供了高质量的流传输服务。

安全实时传输协议[Secure Real-Time Transport Protocol(SRTP)]向RTP添加了加密服务，以维护流媒体的真实性和完整性，并预防了重放攻击。

互联网控制消息协议
-----------------------------

互联网控制消息协议[Internet Control Message Protocol(ICMP)]是一种IP网络服务，用于报告两台主机之间的连接。它通常用于简单的功能，例如检查来自特定目标主机的响应的ping命令。攻击者一旦进入网络，通常会使用ICMP数据包来检查主机的可用性。这些信息可以帮助它们决定将攻击转向何处。

Internet协议安全
-------------------------

Internet协议安全[Internet Protocol Security(IPSec)]是一组开放的非专用标准，你可以使用它们来保护数据在网络或互联网上传输的安全。IPSec使用不同的协议和服务来提供数据真实性和完整性，防重放保护，不可否认性以及放置窃听和嗅探。与SSL/TLS和SSH不同，IPSec在OSI模型的网络层（第3层）中运行，因此该协议不依赖于应用程序。

IPSec中使用两种主要协议。一种是认证报头[Authentication Header(AH)]，它为传输数据的来源提供身份验证，并提供了完整性和防止重放攻击的保护。封装安全有效负荷[Encapsulation Security Payload(ESP)]提供了与AH相同的功能，并增加了加密功能以支持传输数据的机密性。

许多操作系统都支持IPSec，包括Microsoft Windows和Windows Server，Linux和Unix的当前支持版本。联网设备（如大多数路由器）也支持IPSec。虽然IPSec是行业标准，但他在每个操作系统和设备中的实施方式都不相同。

IPSec模式
^^^^^^^^^^^^^^^^^^^

IPSec有两种主要的操作模式：传输模式和隧道模式。在传输模式下，只有数据包内容被加密，而报头则不会被加密。传输模式通常用于远程访问VPN。在隧道模式下，数据包内容和报头都被加密。隧道模式通常用于站点到站点的VPN。

IPSec策略
^^^^^^^^^^^^^^^^^^^^^

IPSec策略是一组安全配置的设置集合，其中定义启用了IPSec的系统将如何响应IP网络流量。该策略确定IPSec连接的安全级别和其他特征。每台使用IPSec的计算机都必须具有一项被分配策略。策略成对出现；网络通讯中的每个端点都必须有一个IPSec策略，以及至少一个与之匹配的安全方法，以确保通讯成功。

网络基本输入\输出系统
-------------------------------

网络基本输入\输出系统[Network Basic Input/Output System(NetBIOS)]是一种能使应用程序在网络中的不同计算机之间正确通讯的服务。NetBIOS有三个基本功能：基于会话的通讯，使用数据报的无连接通讯和名称注册。攻击者可以通过获取有关系统的信息来利用NetBIOS，这些信息包括注册名称，IP地址及使用的操作系统/应用程序。为了加强NetBIOS防御攻击的能力，你应该实施强密码策略，限制网络共享的根访问权限，并禁用空会话功能。

文件传输协议
--------------------

下表介绍了用于支持网络内和网络间文件传输的协议。

.. csv-table:: 文件传输协议
    :header: "协议", "描述"
    :widths: 5 30

    "文件传输协议（FTP）", "该协议实现了用户工作站和远程主机之间的文件传输。通过FTP，用户可以访问远程主机上的目录结构，更改目录，搜索和重命名文件和目录，以及下载和上载文件。"
    "简单文件传输协议（SFTP）", "这种协议使一个早期的不安全文件传输协议，后来被宣布已经过时。"
    "普通文件传输协议（TFTP）", "这是一种非常有限的协议，主要用于自动配置机器间启动文件与路由器和交换机固件更新的过程。由于它几乎不提供安全性，因此这种协议主要用在本地网络上而不是互联网。"
    "基于SSH的FTP", "也称为安全FTP(Secure FTP)，基于SSH的FTP是FTP的安全版本，它使用SSH隧道作为加密方式来进行传输，访问和管理文件。安全FTP主要用于Windows系统。"
    "安全复制协议（SCP）", "这种协议使用SSH在本地和远程主机之间或两台远程主机之间安全的传输计算机文件。SCP也可以通过使用SCP或SFTP执行安全复制的命令行工具来实现。SCP主要用在Linux和Unix系统中。"
    "文件传输协议安全(FTPS)", "该协议也被称为FTP-SSL，它在FTP的使用中结合了对SSL/TLS的额外支持。"

电子邮件协议
-------------------------

电子邮件传输中使用的两种主要协议是邮局协议[Post Office Protocol(POP)]和Internet消息访问协议[Internet Message Access Protocol（IMAP）]。IMAP是较新的一种协议，用来弥补POP的一些缺点，包括多客户端访问同一收件箱的能力以及跟踪消息状态的能力。这两种协议本身都不支持加密。但是，安全POP和安全IMAP扩展让使用这些协议的电子邮件得以利用SSL/TLS。

.. note:: 安全POP/IMAP也被称为POP3S/IMAPS，基于SSL的POP/IMAP，和使用SSL的POP/IMAP。

安全/多用途Internet邮件扩展[Secure/Multipurpose Internet Mail Extensions（S/MIME）]是一种电子邮件加密标准，它使用公钥加密技术将数字签名添加到传统的MIME通讯中。MIME定义了电子邮件以前不可用的几种高级特性，包括能够发送除ASCII以外的字符集文本的能力，以及发送非文本文件附件的能力。S/MIME提供了保密性、完整性、身份验证和不可否认性的保障，并且内置与大多数现代带电子邮件客户端中。

其他联网协议和服务
---------------------------------------

下表介绍了一些其他的联网协议和服务。

.. csv-table:: 其他联网协议和服务
    :header: "协议/服务", "描述"
    :widths: 5 30 

    "电话", "电话（Telephony）通过远距离的设备提供语音和视频通讯。一种常见的电话协议是VoIP，在这种协议中语音流量通过IP网络传输。网络会议平台还为VoIP增添了视频功能。"
    "路由和交换", "路由和交换协议定义了这些设备进行通讯时所使用语言。常见的路由协议包括路由信息协议[Routing Information Protocol（RIP）]及其前身RIPv2。RIPv2通过启用密码验证和使用密钥验证进入路由器的路由信息来支持安全性。对RIPv2的进一步改进包括Cisco专有的内部网关路由协议[Interior Gateway Routing Protocol（IGRP）]和增强型内部网关路由协议[Enhanced Interior Gateway Routing Protocol（EIGRP）]。"
    "时间同步", "时间同步确保软件和服务协调得当，系统生成的所有类型的事件对于事件发生的事件都是准确的。提供时间同步的最突出的协议时网络时间协议[Network Time Protocol（NTP）]。NTP通常通过联络公共时间服务器将计算机系统的时间同步到协调时间时（UTC）。但是，你也可以设置自己的本地时间服务器以实现更精确的计时，同时免除了配置外围防火墙以允许NTP流量进出网络的必要性。"
    "订阅", "订阅协议和服务使发布者能沿着特定频道发送信息，并且订阅了该频道的任何客户端都将收到这些消息。这使发布者能够在不知道实际收件人的情况下发送消息。丰富站点摘要[Rich Site Summary（RSS）]是最受欢迎的订阅技术，它使用户能够订阅每个感兴趣的站点的订阅源（feed）。参与的网站会自动将新条目发布到网站的订阅源中，如新闻网站上的新文章。因此，用户可以跟踪他们订阅的所有订阅源发布的内容。"

端口和端口范围
----------------------------

如你所知，端口是指逻辑连接的终点。客户端计算机通过指定端口连接到特定服务器程序。所有端口都被分配了一个从0到65535范围的数字。互联网编号分配机构（IANA）将端口号分为三个模块：知名端口，是指由IANA预先分配给广泛使用的核心服务的端口；注册端口，这些端口可用于通过IANA请求注册的服务；以及动态端口，这些端口出现服务请求时由客户端操作系统按需分配。

.. note:: IANA管理知名端口的注册，为了方便起见，还列出了注册端口。有关TCP和UDP端口的完整列表，请参阅IANA网站：https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml?&page=1

TCP和UDP端口在下表列出的三种范围之内进行分配。黑客可能会针对常用的知名端口进行攻击，但也可能会扫描开放的注册端口或动态端口。

.. csv-table:: 端口范围
    :header: "端口范围", "号码", "描述"
    :widtsh: 5 5 25

    "著名端口", "0-1023", "特定端口号最容易受到攻击。"
    "注册端口", "1024-49151", "这些端口系统性太强而无法作为攻击者的直接目标，但他们也可能会扫描此范围内的开放端口。"
    "动态或私有端口", "49152-65535", "不断变化；无法确定具体数字，但攻击者可能会扫描此范围内的开放端口。"

.. note:: 一些操作系统使用不同范围作为动态端口，而不是上表列举出来的内容。

常见的默认网络端口
^^^^^^^^^^^^^^^^^^^^^^

这张表列举了一些最常见的网络端口号。

.. csv-table:: 常见的默认网络端口
    :header: "端口号", "服务"
    :widths: 5 10

    "21", "FTP（文件传输协议）"
    "22", "SSH（安全Shell）"
    "53", "DNS（域名系统）"
    "80", "HTTP（超文本传输协议）"
    "443", "HTTPS（超文本传输协议安全）"
    "990", "FTPS（文件传输协议安全）"
    "993", "安全IMAP"
    "995", "安全POP"
    "3389", "RDP（远程桌面协议）"

    